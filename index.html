<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Air Letter Tracing</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    #videoElement, #canvasElement {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #videoElement {
      transform: scaleX(-1);
    }
  </style>
</head>
<body>
  <video id="videoElement" autoplay playsinline></video>
  <canvas id="canvasElement"></canvas>

  <!-- Load TensorFlow.js and the HandPose model -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>

  <script>
    // Get references to the video and canvas elements
    const video = document.getElementById('videoElement');
    const canvas = document.getElementById('canvasElement');
    const ctx = canvas.getContext('2d');

    let handposeModel;
    let currentDotIndex = 0;

    // Define the letter 'A' as a series of dots (relative positions)
    const letterDots = [
      { x: 0.5, y: 0.2 },
      { x: 0.3, y: 0.8 },
      { x: 0.7, y: 0.8 },
      { x: 0.4, y: 0.5 },
      { x: 0.6, y: 0.5 },
    ];

    // Access the user's webcam
    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'user' },
        audio: false,
      });
      video.srcObject = stream;
      return new Promise((resolve) => {
        video.onloadedmetadata = () => {
          resolve();
        };
      });
    }

    // Load the HandPose model
    async function loadHandposeModel() {
      handposeModel = await handpose.load();
    }

    // Resize canvas to match video dimensions
    function resizeCanvas() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
    }

    // Draw the dots on the canvas
    function drawDots() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      letterDots.forEach((dot, index) => {
        // Convert relative positions to absolute positions
        const dotX = dot.x * canvas.width;
        const dotY = dot.y * canvas.height;

        if (index < currentDotIndex) {
          ctx.fillStyle = 'white';
        } else if (index === currentDotIndex) {
          ctx.fillStyle = 'green';
        } else {
          ctx.fillStyle = 'rgba(128, 128, 128, 0.5)';
        }
        ctx.beginPath();
        ctx.arc(dotX, dotY, 20, 0, Math.PI * 2);
        ctx.fill();
      });
    }

    // Main loop to detect hands and update the UI
    async function mainLoop() {
      const predictions = await handposeModel.estimateHands(video, true);

      drawDots();

      if (predictions.length > 0) {
        const landmarks = predictions[0].landmarks;
        const indexFingerTip = landmarks[8]; // Index finger tip

        // Flip the x-coordinate since the video is mirrored
        const fingerX = canvas.width - indexFingerTip[0];
        const fingerY = indexFingerTip[1];

        // Draw the fingertip position
        ctx.fillStyle = 'red';
        ctx.beginPath();
        ctx.arc(fingerX, fingerY, 10, 0, Math.PI * 2);
        ctx.fill();

        // Check if the fingertip is close to the current dot
        const targetDot = letterDots[currentDotIndex];
        const targetX = targetDot.x * canvas.width;
        const targetY = targetDot.y * canvas.height;

        const distance = Math.hypot(fingerX - targetX, fingerY - targetY);

        if (distance < 40) {
          currentDotIndex++;
          if (currentDotIndex >= letterDots.length) {
            alert('Well done! You have traced the letter.');
            currentDotIndex = 0; // Reset for the next round
          }
        }
      }

      requestAnimationFrame(mainLoop);
    }

    // Initialize the application
    async function init() {
      await setupCamera();
      await loadHandposeModel();
      video.play();

      // Resize canvas once video dimensions are available
      resizeCanvas();

      // Redraw canvas when the window is resized
      window.addEventListener('resize', resizeCanvas);

      mainLoop();
    }

    init();
  </script>
</body>
</html>